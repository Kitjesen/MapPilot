# OTA 更新操作指南

## 概述

大算机器人支持 Over-The-Air (OTA) 远程更新，包括：
- **固件更新** — 系统软件包 (.bin, .deb)
- **模型更新** — AI 推理模型 (.onnx, .engine, .pt)
- **地图更新** — SLAM 点云地图 (.pcd)
- **配置更新** — 系统配置文件 (.yaml, .json)

## 更新流程

```
云端仓库 → App 下载 → App 上传到机器人 → 预检查 → 安装 → 验证
```

每次更新都经过完整的**事务式部署**流程，包含 6 个阶段：

| 阶段 | 说明 | 可恢复 |
|------|------|--------|
| 下载 (Downloading) | 从云端下载到 App 本地 | 可重试 |
| 上传 (Uploading) | 从 App 传输到机器人 | 可断点续传 |
| 预检查 (Checking) | 校验哈希、兼容性、磁盘、电量 | 可重试 |
| 安装 (Applying) | 备份旧版 → 安装新版 | 可回滚 |
| 验证 (Validating) | 确认版本一致、服务健康 | 可重试 |
| 完成 (Completed) | 更新成功 | — |

## 操作步骤

### 从云端更新（推荐）

1. 打开 设置 → 固件升级 (OTA)
2. 点击 **"检查更新"** 获取最新版本列表
3. 查看每个资产的详情（名称、大小、类别、兼容性）
4. 点击目标资产旁的 **"部署"** 按钮
5. 观察进度条：
   - 0-40%: 下载中
   - 40-80%: 上传中
   - 80-90%: 预检查
   - 90-95%: 安装中
   - 95-100%: 验证中
6. 出现 "部署完成" 提示即为成功

### 从本地文件更新

1. 打开 设置 → 固件升级 (OTA)
2. 点击 **"选择固件文件并上传"**
3. 从文件选择器中选取固件/模型文件
4. 流程自动执行（跳过下载阶段）

### 更新失败处理

如果更新在任何阶段失败：
1. 查看错误信息（显示在进度条下方）
2. 点击 **"重试"** 按钮
3. App 会自动从失败的阶段继续，已完成的阶段不会重复执行

## 双板 OTA

机器人有两块板子，更新路径不同：

### Nav Board (导航板)
- 直接通过 App → gRPC → ota_daemon (端口 50052) 更新
- 包含：SLAM 固件、地图、YOLO 模型、系统配置

### Dog Board (运动板)
- 通过 Nav Board 代理：App → Nav Board ota_daemon → 文件复制 → 通知 Dog Board 热加载
- 包含：步态模型 (policy_walk, policy_stand)、运动控制参数

App 端无需区分，系统根据 manifest 中的 `target_board` 字段自动路由。

## 安全机制

- **电量检查**: 电量低于 30% 时阻止更新
- **运动检查**: 关键更新前自动让机器人坐下
- **任务检查**: 有任务执行中时阻止 COLD 级别更新
- **哈希校验**: 每个文件上传后验证 SHA256
- **自动备份**: 安装前自动备份当前版本，支持回滚

## 配置更新源

进入 设置 → 云端更新源：
- **GitHub 模式**: 输入组织名和仓库名
- **自定义 URL 模式**: 输入自建 OTA 服务器地址
