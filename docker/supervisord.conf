; ═══════════════════════════════════════════════════════════════
; 3d_NAV Supervisor Configuration
;
; 替代 systemd 管理容器内的多个 ROS2 launch 进程
; 进程依赖链: lidar → slam → (autonomy + planning), grpc 独立
; ═══════════════════════════════════════════════════════════════

[supervisord]
nodaemon=true
logfile=/opt/robot/logs/supervisord.log
logfile_maxbytes=10MB
logfile_backups=3
loglevel=info
pidfile=/tmp/supervisord.pid

; ── LiDAR 驱动 ──
[program:nav-lidar]
command=bash -c "source /opt/ros/%(ENV_ROS_DISTRO)s/setup.bash && source /opt/nav/install/setup.bash && ros2 launch /opt/nav/launch/subsystems/lidar.launch.py"
directory=/opt/nav
autostart=%(ENV_ENABLE_LIDAR)s
autorestart=true
startsecs=5
startretries=3
stopwaitsecs=10
stopsignal=INT
stdout_logfile=/opt/robot/logs/nav-lidar.log
stdout_logfile_maxbytes=20MB
stdout_logfile_backups=3
stderr_redirect=true
priority=100

; ── SLAM (Fast-LIO2) ──
[program:nav-slam]
command=bash -c "source /opt/ros/%(ENV_ROS_DISTRO)s/setup.bash && source /opt/nav/install/setup.bash && ros2 launch /opt/nav/launch/subsystems/slam.launch.py"
directory=/opt/nav
autostart=%(ENV_ENABLE_SLAM)s
autorestart=true
startsecs=10
startretries=3
stopwaitsecs=10
stopsignal=INT
stdout_logfile=/opt/robot/logs/nav-slam.log
stdout_logfile_maxbytes=20MB
stdout_logfile_backups=3
stderr_redirect=true
priority=200

; ── 自主导航 (局部规划 + 地形分析) ──
[program:nav-autonomy]
command=bash -c "source /opt/ros/%(ENV_ROS_DISTRO)s/setup.bash && source /opt/nav/install/setup.bash && ros2 launch /opt/nav/launch/subsystems/autonomy.launch.py"
directory=/opt/nav
autostart=%(ENV_ENABLE_AUTONOMY)s
autorestart=true
startsecs=10
startretries=3
stopwaitsecs=10
stopsignal=INT
stdout_logfile=/opt/robot/logs/nav-autonomy.log
stdout_logfile_maxbytes=20MB
stdout_logfile_backups=3
stderr_redirect=true
priority=300

; ── 全局规划 (定位 + PCT) ──
[program:nav-planning]
command=bash -c "source /opt/ros/%(ENV_ROS_DISTRO)s/setup.bash && source /opt/nav/install/setup.bash && ros2 launch /opt/nav/launch/subsystems/planning.launch.py"
directory=/opt/nav
autostart=%(ENV_ENABLE_PLANNING)s
autorestart=true
startsecs=10
startretries=3
stopwaitsecs=10
stopsignal=INT
stdout_logfile=/opt/robot/logs/nav-planning.log
stdout_logfile_maxbytes=20MB
stdout_logfile_backups=3
stderr_redirect=true
priority=300
environment=NAV_MAP_PATH="%(ENV_NAV_MAP_PATH)s",NAV_INIT_X="%(ENV_NAV_INIT_X)s",NAV_INIT_Y="%(ENV_NAV_INIT_Y)s",NAV_INIT_Z="%(ENV_NAV_INIT_Z)s",NAV_INIT_YAW="%(ENV_NAV_INIT_YAW)s"

; ── gRPC Gateway ──
[program:nav-grpc]
command=bash -c "source /opt/ros/%(ENV_ROS_DISTRO)s/setup.bash && source /opt/nav/install/setup.bash && ros2 launch /opt/nav/launch/subsystems/grpc.launch.py"
directory=/opt/nav
autostart=true
autorestart=true
startsecs=5
startretries=5
stopwaitsecs=10
stopsignal=INT
stdout_logfile=/opt/robot/logs/nav-grpc.log
stdout_logfile_maxbytes=20MB
stdout_logfile_backups=3
stderr_redirect=true
priority=50

; ── OTA Daemon ──
[program:ota-daemon]
command=/opt/nav/install/ota_daemon/bin/ota_daemon --config /opt/nav/ota_config/ota_daemon.yaml
directory=/opt/nav
autostart=%(ENV_ENABLE_OTA)s
autorestart=true
startsecs=3
startretries=3
stopwaitsecs=5
stopsignal=INT
stdout_logfile=/opt/robot/logs/ota-daemon.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=2
stderr_redirect=true
priority=50

; ── 进程组 ──
[group:navigation]
programs=nav-lidar,nav-slam,nav-autonomy,nav-planning
priority=200

[group:services]
programs=nav-grpc,ota-daemon
priority=50

; ── supervisorctl 远程控制 ──
[inet_http_server]
port=127.0.0.1:9001

[supervisorctl]
serverurl=http://127.0.0.1:9001

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface
