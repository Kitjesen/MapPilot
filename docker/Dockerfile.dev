# ═══════════════════════════════════════════════════════════════
# 3d_NAV Development Container
#
# 用途: 开发者本地编译 + 调试, 源码通过 volume 挂载
#
# 构建:
#   docker build -f docker/Dockerfile.dev -t 3dnav-dev:latest .
#
# 使用:
#   docker compose -f docker-compose.yml -f docker-compose.dev.yml up
# ═══════════════════════════════════════════════════════════════

ARG ROS_DISTRO=humble
FROM ros:${ROS_DISTRO}

SHELL ["/bin/bash", "-c"]
ENV DEBIAN_FRONTEND=noninteractive

# ── 完整编译 + 调试工具链 ──
RUN apt-get update && apt-get install -y --no-install-recommends \
    # 编译
    build-essential \
    cmake \
    ninja-build \
    ccache \
    python3-colcon-common-extensions \
    python3-rosdep \
    python3-pip \
    # 库依赖
    libpcl-dev \
    libeigen3-dev \
    libopencv-dev \
    libgrpc++-dev \
    libssl-dev \
    protobuf-compiler-grpc \
    python3-pybind11 \
    libboost-all-dev \
    libgrpc-dev \
    pkg-config \
    # ROS2 包
    ros-${ROS_DISTRO}-tf2-ros \
    ros-${ROS_DISTRO}-nav-msgs \
    ros-${ROS_DISTRO}-sensor-msgs \
    ros-${ROS_DISTRO}-geometry-msgs \
    ros-${ROS_DISTRO}-rviz2 \
    ros-${ROS_DISTRO}-rqt* \
    # 调试工具
    gdb \
    valgrind \
    strace \
    htop \
    vim \
    tmux \
    iproute2 \
    iputils-ping \
    net-tools \
    # C++ 代码质量
    clang-format \
    clang-tidy \
    # gtest
    libgtest-dev \
    libgmock-dev \
    # 进程管理
    supervisor \
    && rm -rf /var/lib/apt/lists/*

# ── 安装 pre-commit ──
RUN pip3 install --no-cache-dir pre-commit

# ── 创建开发用户 (映射宿主机 UID) ──
ARG HOST_UID=1000
ARG HOST_GID=1000
RUN groupadd -g ${HOST_GID} devuser 2>/dev/null || true && \
    useradd -m -u ${HOST_UID} -g ${HOST_GID} -s /bin/bash devuser && \
    echo "devuser ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers && \
    mkdir -p /opt/nav /opt/robot/logs /opt/robot/flight_records \
             /opt/robot/ota /opt/robot/bags /etc/nav && \
    chown -R devuser:devuser /opt/robot

# ── ccache 配置 ──
ENV CCACHE_DIR=/ws/.ccache \
    CMAKE_CXX_COMPILER_LAUNCHER=ccache \
    CMAKE_C_COMPILER_LAUNCHER=ccache

# ── 环境 ──
ENV ROS_DISTRO=${ROS_DISTRO} \
    NAV_DIR=/ws \
    NAV_LOG_DIR=/opt/robot/logs \
    NAV_MAP_DIR=/ws/maps \
    RMW_IMPLEMENTATION=rmw_cyclonedds_cpp \
    CYCLONEDDS_URI=file:///nav_ws/config/cyclonedds.xml \
    LANG=en_US.UTF-8

# ── Shell 配置 ──
RUN echo 'source /opt/ros/${ROS_DISTRO}/setup.bash' >> /home/devuser/.bashrc && \
    echo '[ -f /ws/install/setup.bash ] && source /ws/install/setup.bash' >> /home/devuser/.bashrc && \
    echo 'export PS1="\[\033[1;36m\][nav-dev]\[\033[0m\] \w\$ "' >> /home/devuser/.bashrc

WORKDIR /ws
USER devuser

EXPOSE 50051 50052

CMD ["/bin/bash"]
